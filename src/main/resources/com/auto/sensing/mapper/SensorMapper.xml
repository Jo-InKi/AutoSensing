<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SensorMapper">
	<select id="selectSensorCompanyAll"
		resultType="com.auto.sensing.dto.SensorCompanyDTO">
		SELECT
			  code
			, name
		  FROM
			code_tb
		 WHERE class='SensorCompany'
	</select>
	<select id="selectCompanySensor" parameterType="String"
		resultType="com.auto.sensing.dto.SensorCompanyDTO">
		SELECT
			  code
			, name
		  FROM
			sensorlist_tb
		 WHERE sensorcompany = #{company}
	</select>

	<select id="selectSensorListByProjectID" parameterType="String"
		resultType="com.auto.sensing.vo.SensorVO">
		SELECT
			sensorid
			, channel
			, IFNULL(sensorname, 'default') as sensorname
			, substring(kind,1,4) as sensorcompany
			, substring(kind,5,4) as sensorcode
			, initdate
			, factor
			, guidel1max
			, guidel1min
			, guidel2max
			, guidel2min
			, guidel3max
			, guidel3min
			, const1
			, const2
			, const3
			, const4
			, const5
			, const6
			, const7
			, const8
			, calcstring
			, projectid
			, location_sn
		FROM
			sensor_tb
		<where>
			<if test="projectid != null and projectid != ''">
				AND projectid = #{projectid}
			</if>
		</where>
	</select>
	
	<select id="selectSensorListByPage" parameterType="com.auto.sensing.vo.PageVO" resultType="com.auto.sensing.vo.SensorVO">
		SELECT
			*
		FROM sensor_tb
		<trim prefix="where" prefixOverrides="AND">
			<if test="search.keyword != null and search.keyword !=''">
				<if test="search.keywordType == 'sensorid'">
					sensorid LIKE CONCAT('%', #{search.keyword}, '%')
				</if>
			</if>
		</trim>
		ORDER BY sensorid, channel ASC
		LIMIT ${amount} OFFSET ${(pageNum-1)*amount};
	</select>


	<select id="selectSensorCntByPage" parameterType="com.auto.sensing.vo.PageVO" resultType="Integer">
		SELECT
			COUNT(*)
		FROM sensor_tb
		<trim prefix="where" prefixOverrides="AND">
			<if test="search.keyword != null and search.keyword !=''">
				<if test="search.keywordType == 'sensorid'">
					sensorid LIKE CONCAT('%', #{search.keyword}, '%')
				</if>
			</if>
		</trim>
		ORDER BY sensorid, channel ASC
		LIMIT ${amount} OFFSET ${(pageNum-1)*amount};
	</select>

	
	<select id="selectSensorListLocationSN" parameterType="String"
		resultType="com.auto.sensing.vo.SensorVO">
		SELECT
			sensorid
			, channel
			, IFNULL(sensorname, 'default') as sensorname
			, substring(kind,1,4) as sensorcompany
			, substring(kind,5,4) as sensorcode
			, initdate
			, factor
			, guidel1max
			, guidel1min
			, guidel2max
			, guidel2min
			, guidel3max
			, guidel3min
			, const1
			, const2
			, const3
			, const4
			, const5
			, const6
			, const7
			, const8
			, calcstring
			, projectid
			, location_sn
		FROM
			sensor_tb
		<where>
			<if test="location_sn != null and location_sn > 0">
				AND location_sn = #{location_sn}
			</if>
		</where>
	</select>
	<select id="selectSensor" parameterType="Map"
		resultType="com.auto.sensing.vo.SensorVO">
		SELECT
			sensorid
			, channel
			, IFNULL(sensorname, 'default') as sensorname
			, initdate
			, factor
			, guidel1max
			, guidel1min
			, guidel2max
			, guidel2min
			, guidel3max
			, guidel3min
			, const1
			, const2
			, const3
			, const4
			, const5
			, const6
			, const7
			, const8
			, calcstring
			, projectid
		FROM
			sensor_tb
		<where>
 			<if test="sensorid != null and sensorid != ''">
				AND sensorid = #{sensorid}
			</if>
			<if test="channel != null and channel >= 0">
				AND channel = #{channel}
			</if>
			<if test="projectid != null and projectid != ''">
				AND projectid = #{projectid}
			</if>
		</where>
	</select>
	
	<select id="selectSensorReport" parameterType="Map" resultType="com.auto.sensing.vo.SensorReportVO">
			SELECT
				TB.keytime as time
				, AVG(TB.aiv) as aiv
			FROM (
				SELECT
					date_format(time, '%Y-%m-%d %H:00') as keytime
					,time
					,aiv
				FROM sensor_report
				WHERE sensorid = #{sensorid}
				AND channel = #{channel}
				AND <![CDATA[time >= #{sdatetime}]]>
				AND <![CDATA[time <= #{edatetime}]]>
			) TB
			GROUP BY TB.keytime
			ORDER BY TB.keytime ASC
	</select>
	
	<select id="selectSensorReportByPage" parameterType="com.auto.sensing.vo.PageVO" resultType="com.auto.sensing.vo.SensorReportVO">
		SELECT
			time AS 'time'
			,avi AS 'avi'
			,0 AS 'value'
		FROM (
			SELECT
				CEIL(TB1.date_idx/1) AS date_idx
				,LPAD(TB1.time_idx - 1, '2', '0') AS time_idx
				,CONCAT_WS(' ', TB1.keydate, TB1.keytime) AS time
				, TB1.keydate AS keydate
				, TB1.keytime AS keytime
				,IFNULL(TB2.avi, 0) AS avi
			FROM (
				SELECT
					RANK() OVER (PARTITION BY keytime ORDER BY keydate ASC) AS date_idx 
					, ROW_NUMBER() OVER (PARTITION BY keydate ORDER BY keytime ASC) AS time_idx
					, TB.*
				 FROM (
				 	WITH RECURSIVE DatetimeRange AS (
					    SELECT STR_TO_DATE(#{search.sdatetime}, '%Y-%m-%d %H:00') AS date
					    UNION ALL
					    SELECT DATE_ADD(date, INTERVAL 1 HOUR)
					    FROM DatetimeRange
					    WHERE <![CDATA[date < STR_TO_DATE(#{search.edatetime}, '%Y-%m-%d %H:00')]]>
					)
					SELECT
						date_format(date, '%Y-%m-%d') AS keydate
						,date_format(date, '%H:00') AS keytime
					FROM DatetimeRange
				) TB
			) TB1
			LEFT JOIN (
				SELECT
					date_format(time, '%Y-%m-%d') as keydate
					,date_format(time, '%H:00') as keytime
					,AVG(aiv) AS avi
				FROM sensor_report
				WHERE sensorid = #{search.sensorid}
				AND channel = #{search.channel}
				AND <![CDATA[time >= #{search.sdatetime}]]>
				AND <![CDATA[time <= #{search.edatetime}]]>
				GROUP BY keydate, keytime
			) TB2
			ON TB1.keydate = TB2.keydate AND TB1.keytime = TB2.keytime
		) TB
		ORDER BY keydate, keytime ASC
		LIMIT ${amount} OFFSET ${(pageNum-1)*amount};
	
<!-- 	
		SELECT
			TB.keytime as time
			, AVG(TB.aiv) as aiv
		FROM (
			SELECT
				date_format(time, '%Y-%m-%d %H:00') as keytime
				,time
				,aiv
			FROM sensor_report
			<trim prefix="where" prefixOverrides="AND">
				<if test="search.sensorid != null and search.sensorid !=''">
					sensorid = #{search.sensorid}
				</if>
				<if test="search.channel != -1">
					AND channel = #{search.channel}
				</if>
				<if test="search.sdatetime != null and search.sdatetime !=''">
					AND <![CDATA[time >= #{search.sdatetime}]]>
				</if>
				<if test="search.edatetime != null and search.edatetime !=''">
					AND <![CDATA[time <= #{search.edatetime}]]>
				</if>
				<if test="search.keyword != null and search.keyword !=''">
				</if>
			</trim>
		) TB
		GROUP BY TB.keytime
		ORDER BY TB.keytime ASC
		LIMIT ${amount} OFFSET ${(pageNum-1)*amount};
 -->
	</select>

	<select id="selectSensorReportCntByPage" parameterType="com.auto.sensing.vo.PageVO" resultType="Integer">
		SELECT
			COUNT(*)
		FROM (
			SELECT
				date_format(time, '%Y-%m-%d %H:00') as keytime
				,time
				,aiv
			FROM sensor_report
			<trim prefix="where" prefixOverrides="AND">
				<if test="search.sensorid != null and search.sensorid !=''">
					sensorid = #{search.sensorid}
				</if>
				<if test="search.channel != -1">
					AND channel = #{search.channel}
				</if>
				<if test="search.sdatetime != null and search.sdatetime !=''">
					AND <![CDATA[time >= #{search.sdatetime}]]>
				</if>
				<if test="search.edatetime != null and search.edatetime !=''">
					AND <![CDATA[time <= #{search.edatetime}]]>
				</if>
				<if test="search.keyword != null and search.keyword !=''">
				</if>
			</trim>
			GROUP BY keytime
		) TB
	</select>
	
	<insert id="insertSensor" parameterType="com.auto.sensing.vo.SensorVO">
	INSERT INTO sensor_tb
	(
            sensorid
            , channel
            , sensorname
            , initdate
            , factor
            , guidel1max
            , guidel1min
            , guidel2max
            , guidel2min
            , guidel3max
            , guidel3min
            , const1
            , const2
            , const3
            , const4
            , const5
            , const6
            , const7
            , const8
			, calcstring
			, projectid
			, location_sn
			
	)
	values (
            #{sensorid}
            , #{channel}
            , #{sensorname}
            , #{initdate}
            , #{factor}
            , #{guidel1max}
            , #{guidel1min}
            , #{guidel2max}
            , #{guidel2min}
            , #{guidel3max}
            , #{guidel3min}
            , #{const1}
            , #{const2}
            , #{const3}
            , #{const4}
            , #{const5}
            , #{const6}
            , #{const7}
            , #{const8}
            , #{calcstring}
	        , #{projectid}
			, #{location_sn}
	)
	</insert>
	<update id="updateSensor" parameterType="com.auto.sensing.vo.SensorVO">
	UPDATE sensor_tb SET
              sensorname      = #{sensorname}
            , initdate      = #{initdate}
            , factor        = #{factor}
            , guidel1max    = #{guidel1max}
            , guidel1min    = #{guidel1min}
            , guidel2max    = #{guidel2max}
            , guidel2min    = #{guidel2min}
            , guidel3max    = #{guidel3max}
            , guidel3min    = #{guidel3min}
            , const1        = #{const1}
            , const2        = #{const2}
            , const3        = #{const3}
            , const4        = #{const4}
            , const5        = #{const5}
            , const6        = #{const6}
            , const7        = #{const7}
            , const8        = #{const8}
            , userid        = #{userid}
			, calcstring	= #{calcstring}
	WHERE	projectid		= #{projectid}
	  AND	sensorid		= #{sensorid}
	  AND	channel			= #{channel}
	</update>
	
	<delete id = "deleteSensor" parameterType="Map">
	DELETE FROM sensor_tb
	 WHERE	projectid = #{projectid}
	   AND	sensorid = #{sensorid}
	   AND	channel = #{channel}
	 </delete>
</mapper>